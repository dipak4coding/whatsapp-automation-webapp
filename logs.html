{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">
            <i class="fas fa-list text-primary me-2"></i>
            Activity Logs
        </h2>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-text me-2"></i>Recent Activity
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshLogs">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="clearLogs">
                        <i class="fas fa-trash me-1"></i>Clear
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <select class="form-select form-select-sm" id="logLevel">
                            <option value="all">All Levels</option>
                            <option value="INFO">Info</option>
                            <option value="WARNING">Warning</option>
                            <option value="ERROR">Error</option>
                            <option value="CRITICAL">Critical</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="logSearch" 
                               placeholder="Search logs...">
                    </div>
                </div>
                
                <div id="logsContainer" style="height: 500px; overflow-y: auto;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Loading logs...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-info-circle fa-2x text-info mb-2"></i>
                        <h5 class="card-title" id="infoCount">0</h5>
                        <p class="card-text">Info Messages</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h5 class="card-title" id="warningCount">0</h5>
                        <p class="card-text">Warnings</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                        <h5 class="card-title" id="errorCount">0</h5>
                        <p class="card-text">Errors</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-paper-plane fa-2x text-success mb-2"></i>
                        <h5 class="card-title" id="messageCount">0</h5>
                        <p class="card-text">Messages Sent</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allLogs = [];

$(document).ready(function() {
    loadLogs();
    
    // Refresh logs button
    $('#refreshLogs').on('click', function() {
        loadLogs();
    });
    
    // Clear logs button
    $('#clearLogs').on('click', function() {
        if (confirm('Are you sure you want to clear all logs?')) {
            clearLogs();
        }
    });
    
    // Filter by log level
    $('#logLevel').on('change', function() {
        filterLogs();
    });
    
    // Search logs
    $('#logSearch').on('input', function() {
        filterLogs();
    });
    
    // Auto-refresh every 30 seconds
    setInterval(loadLogs, 30000);
});

function loadLogs() {
    // Simulate loading logs (replace with actual endpoint)
    const sampleLogs = generateSampleLogs();
    allLogs = sampleLogs;
    filterLogs();
    updateStatistics();
}

function generateSampleLogs() {
    const levels = ['INFO', 'WARNING', 'ERROR', 'CRITICAL'];
    const messages = [
        'Script started successfully',
        'CSV file loaded with 150 rows',
        'WebDriver initialized',
        'WhatsApp Web session is active',
        'Message sent to John Doe (+1234567890)',
        'Failed to send message to Jane Smith (+9876543210)',
        'Configuration saved successfully',
        'Backup created for user data',
        'Session check completed',
        'Process completed successfully'
    ];
    
    const logs = [];
    for (let i = 0; i < 50; i++) {
        const level = levels[Math.floor(Math.random() * levels.length)];
        const message = messages[Math.floor(Math.random() * messages.length)];
        const timestamp = new Date(Date.now() - Math.random() * 86400000).toISOString();
        
        logs.push({
            timestamp: timestamp,
            level: level,
            message: message
        });
    }
    
    return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
}

function filterLogs() {
    const levelFilter = $('#logLevel').val();
    const searchTerm = $('#logSearch').val().toLowerCase();
    
    let filteredLogs = allLogs;
    
    if (levelFilter !== 'all') {
        filteredLogs = filteredLogs.filter(log => log.level === levelFilter);
    }
    
    if (searchTerm) {
        filteredLogs = filteredLogs.filter(log => 
            log.message.toLowerCase().includes(searchTerm)
        );
    }
    
    displayLogs(filteredLogs);
}

function displayLogs(logs) {
    let logsHtml = '';
    
    if (logs.length === 0) {
        logsHtml = `
            <div class="text-center text-muted">
                <i class="fas fa-search fa-2x"></i>
                <p class="mt-2">No logs found matching the criteria</p>
            </div>
        `;
    } else {
        logs.forEach(function(log) {
            const levelClass = getLevelClass(log.level);
            const levelIcon = getLevelIcon(log.level);
            const timestamp = new Date(log.timestamp).toLocaleString();
            
            logsHtml += `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <span class="badge ${levelClass} me-2">
                                <i class="${levelIcon} me-1"></i>${log.level}
                            </span>
                            <span class="text-muted small">${timestamp}</span>
                            <div class="mt-1">${log.message}</div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    $('#logsContainer').html(logsHtml);
}

function getLevelClass(level) {
    const classes = {
        'INFO': 'bg-info',
        'WARNING': 'bg-warning',
        'ERROR': 'bg-danger',
        'CRITICAL': 'bg-dark'
    };
    return classes[level] || 'bg-secondary';
}

function getLevelIcon(level) {
    const icons = {
        'INFO': 'fas fa-info-circle',
        'WARNING': 'fas fa-exclamation-triangle',
        'ERROR': 'fas fa-times-circle',
        'CRITICAL': 'fas fa-skull-crossbones'
    };
    return icons[level] || 'fas fa-question-circle';
}

function updateStatistics() {
    const stats = {
        INFO: 0,
        WARNING: 0,
        ERROR: 0,
        CRITICAL: 0,
        MESSAGE: 0
    };
    
    allLogs.forEach(function(log) {
        if (stats.hasOwnProperty(log.level)) {
            stats[log.level]++;
        }
        if (log.message.includes('Message sent')) {
            stats.MESSAGE++;
        }
    });
    
    $('#infoCount').text(stats.INFO);
    $('#warningCount').text(stats.WARNING);
    $('#errorCount').text(stats.ERROR + stats.CRITICAL);
    $('#messageCount').text(stats.MESSAGE);
}

function clearLogs() {
    allLogs = [];
    filterLogs();
    updateStatistics();
    
    // Show success message
    $('#logsContainer').html(`
        <div class="alert alert-success text-center">
            <i class="fas fa-check-circle me-2"></i>
            Logs cleared successfully
        </div>
    `);
    
    // Reset after 3 seconds
    setTimeout(function() {
        loadLogs();
    }, 3000);
}
</script>
{% endblock %}