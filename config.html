{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">
            <i class="fas fa-cog text-primary me-2"></i>
            Configuration
        </h2>

        <form id="configForm">
            <!-- Message Templates -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-text me-2"></i>Message Templates
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Use placeholders like {Client}, {Contact}, {NextHearingDate}, {Category}, {TypRnRy}, {Parties} in your templates.
                    </p>

                    <!-- Active Client Template -->
                    <div class="mb-4">
                        <label for="activeTemplate" class="form-label">
                            <strong>Active Client Message Template</strong>
                        </label>
                        <textarea class="form-control" id="activeTemplate" name="active_template" rows="6" 
                                  placeholder="Dear {Client}, your next hearing date is {NextHearingDate}...">{{ templates.get('active_message', 'Dear {Client},

Your next hearing date for the matter {Parties} is scheduled for {NextHearingDate}.

Please ensure you are prepared and available for the hearing.

Best regards,
Legal Team') }}</textarea>
                    </div>

                    <!-- Inactive Client Template -->
                    <div class="mb-4">
                        <label for="inactiveTemplate" class="form-label">
                            <strong>Inactive Client Message Template</strong>
                        </label>
                        <textarea class="form-control" id="inactiveTemplate" name="inactive_template" rows="6" 
                                  placeholder="Dear {Client}, regarding your case...">{{ templates.get('inactive_message', 'Dear {Client},

Regarding your case {Parties}, we wanted to update you that your next hearing is scheduled for {NextHearingDate}.

Please contact us if you need any assistance.

Best regards,
Legal Team') }}</textarea>
                    </div>

                    <!-- No Instruction Template -->
                    <div class="mb-4">
                        <label for="noInstructionTemplate" class="form-label">
                            <strong>No Client Instruction Message Template</strong>
                        </label>
                        <textarea class="form-control" id="noInstructionTemplate" name="no_instruction_template" rows="6" 
                                  placeholder="Dear {Client}, we need your instructions...">{{ templates.get('no_instruction_message', 'Dear {Client},

We need your instructions regarding the matter {Parties} as the next hearing date is {NextHearingDate}.

Please contact us at your earliest convenience.

Best regards,
Legal Team') }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell me-2"></i>Notification Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationContact1" class="form-label">
                                    <strong>Primary Notification Contact</strong>
                                </label>
                                <input type="tel" class="form-control" id="notificationContact1" 
                                       name="notification_contact1" placeholder="+1234567890" value="{{ config.get('notification_contact1', '') }}">
                                <small class="form-text text-muted">Include country code (e.g., +91 for India)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationContact2" class="form-label">
                                    <strong>Secondary Notification Contact</strong>
                                </label>
                                <input type="tel" class="form-control" id="notificationContact2" 
                                       name="notification_contact2" placeholder="+1234567890" value="{{ config.get('notification_contact2', '') }}">
                                <small class="form-text text-muted">Include country code (e.g., +91 for India)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Browser Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-browser me-2"></i>Browser Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="userDataType" class="form-label">
                            <strong>User Data Profile</strong>
                        </label>
                        <select class="form-select" id="userDataType" name="user_data_type">
                            <option value="shs" {% if config.get('user_data_type', 'shs') == 'shs' %}selected{% endif %}>ShS Profile</option>
                            <option value="sud" {% if config.get('user_data_type', 'shs') == 'sud' %}selected{% endif %}>SuD Profile</option>
                        </select>
                        <small class="form-text text-muted">Select which browser profile to use for WhatsApp Web</small>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="text-end">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Save Configuration
                </button>
            </div>
        </form>

        <div id="configStatus" class="mt-3"></div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Message Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Template Type:</strong></label>
                    <p id="previewType"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Sample Message:</strong></label>
                    <div class="border p-3 rounded bg-light">
                        <pre id="previewContent"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Load existing configuration
    loadConfiguration();

    // Save Configuration Form
    $('#configForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            active_template: $('#activeTemplate').val(),
            inactive_template: $('#inactiveTemplate').val(),
            no_instruction_template: $('#noInstructionTemplate').val(),
            notification_contact1: $('#notificationContact1').val(),
            notification_contact2: $('#notificationContact2').val(),
            user_data_type: $('#userDataType').val()
        };
        
        const button = $(this).find('button[type="submit"]');
        const originalText = button.html();
        
        button.html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...').prop('disabled', true);
        
        $.ajax({
            url: '/save_templates',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                $('#configStatus').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${response.success}
                    </div>
                `);
                // Auto-hide success message after 3 seconds
                setTimeout(function() {
                    $('#configStatus').fadeOut();
                }, 3000);
            },
            error: function(xhr) {
                const error = JSON.parse(xhr.responseText).error;
                $('#configStatus').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${error}
                    </div>
                `);
            },
            complete: function() {
                button.html(originalText).prop('disabled', false);
            }
        });
    });

    // Add preview buttons for templates
    addPreviewButtons();
});

function loadConfiguration() {
    // Try to load existing configuration (you can implement this endpoint)
    // For now, we'll use default values
}

function addPreviewButtons() {
    const templates = [
        { id: 'activeTemplate', name: 'Active Client' },
        { id: 'inactiveTemplate', name: 'Inactive Client' },
        { id: 'noInstructionTemplate', name: 'No Client Instruction' }
    ];

    templates.forEach(function(template) {
        const textarea = $(`#${template.id}`);
        const previewButton = $(`
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2 preview-btn" 
                    data-template="${template.id}" data-name="${template.name}">
                <i class="fas fa-eye me-1"></i>Preview
            </button>
        `);
        
        textarea.after(previewButton);
    });

    // Handle preview button clicks
    $('.preview-btn').on('click', function() {
        const templateId = $(this).data('template');
        const templateName = $(this).data('name');
        const templateContent = $(`#${templateId}`).val();
        
        // Create sample data for preview
        const sampleData = {
            Client: 'John Doe',
            Contact: '+1234567890',
            NextHearingDate: '2024-01-15',
            Category: 'Active',
            TypRnRy: 'Civil',
            Parties: 'John Doe vs. ABC Company'
        };
        
        let previewContent = templateContent;
        Object.keys(sampleData).forEach(function(key) {
            const placeholder = new RegExp(`\\{${key}\\}`, 'g');
            previewContent = previewContent.replace(placeholder, sampleData[key]);
        });
        
        $('#previewType').text(templateName);
        $('#previewContent').text(previewContent);
        $('#previewModal').modal('show');
    });
}
</script>
{% endblock %}